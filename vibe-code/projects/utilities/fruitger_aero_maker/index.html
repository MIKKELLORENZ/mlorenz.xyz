<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Frutiger Aero Beat Maker</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Frutiger Aero Background Elements -->
  <div class="aero-bg">
    <div class="bubbles">
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
      <div class="bubble"></div>
    </div>
    <div class="clouds">
      <div class="cloud cloud-1"></div>
      <div class="cloud cloud-2"></div>
      <div class="cloud cloud-3"></div>
    </div>
    <div class="grass"></div>
  </div>

  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="logo">
        <span class="logo-icon">ğŸµ</span>
        <div class="logo-text">
          <h1>Frutiger Aero Beat Maker</h1>
          <span class="tagline">Wii / DSâ€‘inspired scales & syncopation</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-icon" id="undo-btn" title="Undo (Ctrl+Z)" aria-label="Undo" disabled>
          <span>â†©</span>
        </button>
        <button class="btn btn-icon" id="redo-btn" title="Redo (Ctrl+Y)" aria-label="Redo" disabled>
          <span>â†ª</span>
        </button>
        <button class="btn btn-icon" id="help-btn" title="Help & Shortcuts" aria-label="Help">
          <span>?</span>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Transport & Primary Controls -->
      <section class="panel transport-panel">
        <div class="transport-controls">
          <div class="transport-buttons">
            <button class="btn btn-transport btn-play" id="play-btn" aria-label="Play">
              <span class="icon">â–¶</span>
              <span class="label">Play</span>
            </button>
            <button class="btn btn-transport btn-stop" id="stop-btn" aria-label="Stop">
              <span class="icon">â– </span>
              <span class="label">Stop</span>
            </button>
          </div>
          
          <div class="tempo-display">
            <div class="tempo-value" id="tempo-display">85</div>
            <div class="tempo-label">BPM</div>
          </div>
          
          <div class="control-group slider-group">
            <label for="tempo">Tempo</label>
            <input type="range" id="tempo" min="60" max="180" value="85" class="slider">
          </div>
          
          <div class="control-group slider-group">
            <label for="volume">Volume</label>
            <input type="range" id="volume" min="0" max="100" value="75" class="slider">
            <span class="value-display" id="volume-value">75%</span>
          </div>
          
          <div class="control-group slider-group">
            <label for="swing">Swing</label>
            <input type="range" id="swing" min="0" max="50" value="15" class="slider">
            <span class="value-display" id="swing-value">15%</span>
          </div>
        </div>
      </section>

      <!-- Arrangement Grid -->
      <section class="panel arrangement-panel">
        <div class="panel-header">
          <h2>ğŸ¹ Arrangement</h2>
          <div class="panel-actions">
            <div class="control-group compact inline">
              <label for="bars">Bars:</label>
              <select id="bars" class="select-sm">
                <option value="4">4</option>
                <option value="8" selected>8</option>
                <option value="12">12</option>
                <option value="16">16</option>
              </select>
            </div>
            <div class="control-group compact inline">
              <label for="key-root">Key:</label>
              <select id="key-root" class="select-sm">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="B">B</option>
              </select>
            </div>
            <div class="control-group compact inline">
              <label for="scale">Scale:</label>
              <select id="scale" class="select-sm">
                <option value="major">Major</option>
                <option value="minor">Minor</option>
                <option value="pentatonic">Pentatonic</option>
                <option value="lydian" selected>Lydian</option>
                <option value="mixolydian">Mixolydian</option>
                <option value="dorian">Dorian</option>
              </select>
            </div>
            <label class="checkbox-label">
              <input type="checkbox" id="metronome">
              <span>ğŸ”” Metronome</span>
            </label>
            <button class="btn btn-accent" id="randomize-btn" title="Generate random arrangement">
              <span>âœ¨</span> Randomize
            </button>
            <button class="btn btn-danger" id="clear-btn" title="Clear all patterns">
              <span>ğŸ—‘</span> Clear
            </button>
          </div>
        </div>

        <div class="arrangement-grid" id="arrangement-grid" role="grid" aria-label="Pattern arrangement grid">
          <!-- Bar numbers header -->
          <div class="grid-header" id="grid-header">
            <div class="track-label-spacer"></div>
            <!-- Bar numbers inserted by JS -->
          </div>
          
          <!-- Playback indicator -->
          <div class="playhead" id="playhead"></div>
          
          <!-- Track rows will be inserted here -->
          <div class="tracks-container" id="tracks-container"></div>
        </div>
      </section>

      <!-- Bottom Panels -->
      <div class="panels-row">
        <!-- Song Management -->
        <section class="panel save-panel">
          <div class="panel-header">
            <h2>ğŸ’¾ Save & Load</h2>
          </div>
          <div class="panel-content">
            <div class="save-load-row">
              <input type="text" id="song-name" placeholder="Song name..." class="input">
              <button class="btn btn-primary" id="save-btn">
                <span>ğŸ’¾</span> Save
              </button>
              <select id="load-song" class="select">
                <option value="">Load saved...</option>
              </select>
              <button class="btn btn-ghost" id="delete-btn" title="Delete selected song">
                ğŸ—‘
              </button>
            </div>
            <div class="export-row">
              <button class="btn btn-secondary" id="export-json-btn">
                ğŸ“¤ JSON
              </button>
              <button class="btn btn-secondary" id="import-json-btn">
                ğŸ“¥ Import
              </button>
              <input type="file" id="import-file" accept=".json" hidden>
              <button class="btn btn-primary" id="export-wav-btn">
                ğŸ§ Export WAV
              </button>
            </div>
          </div>
        </section>

        <!-- Per-Track Effects (Collapsible) -->
        <section class="panel effects-panel collapsible" data-collapsed="true">
          <div class="panel-header clickable" data-toggle="collapse">
            <h2>ğŸ›ï¸ Track Mixer</h2>
            <span class="collapse-icon">â–¶</span>
          </div>
          <div class="panel-content" style="display: none;">
            <div class="effects-grid" id="effects-grid">
              <!-- Generated by JS -->
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <p>Built with Web Audio API â€¢ All data stays in your browser</p>
      <p class="shortcuts-hint"><kbd>Space</kbd> Play/Pause â€¢ <kbd>Ctrl+Z</kbd> Undo â€¢ <kbd>?</kbd> Help</p>
    </footer>
  </div>

  <!-- Pattern Selection Modal -->
  <div class="modal" id="pattern-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Select Pattern</h3>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="pattern-search">
          <input type="text" id="pattern-search" placeholder="Search patterns..." class="input">
        </div>
        <div class="pattern-grid" id="pattern-grid" role="listbox"></div>
      </div>
      <div class="modal-footer">
        <label class="checkbox-label">
          <input type="checkbox" id="preview-enabled" checked>
          <span>ğŸ”Š Preview on hover</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="help-modal" role="dialog" aria-labelledby="help-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="help-title">Help & Keyboard Shortcuts</h3>
        <button class="modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body help-body">
        <div class="help-section">
          <h4>ğŸ¹ Getting Started</h4>
          <p>Click on any cell in the arrangement grid to assign a pattern. Each row represents a different instrument track. Build your song by filling in patterns across the bars.</p>
        </div>
        <div class="help-section">
          <h4>âŒ¨ï¸ Keyboard Shortcuts</h4>
          <div class="shortcuts-grid">
            <div><kbd>Space</kbd></div><div>Play / Pause</div>
            <div><kbd>Ctrl</kbd>+<kbd>Z</kbd></div><div>Undo</div>
            <div><kbd>Ctrl</kbd>+<kbd>Y</kbd></div><div>Redo</div>
            <div><kbd>Ctrl</kbd>+<kbd>S</kbd></div><div>Save song</div>
            <div><kbd>Delete</kbd></div><div>Clear selected cell</div>
            <div><kbd>â†</kbd> <kbd>â†’</kbd></div><div>Navigate bars</div>
            <div><kbd>â†‘</kbd> <kbd>â†“</kbd></div><div>Navigate tracks</div>
          </div>
        </div>
        <div class="help-section">
          <h4>ğŸµ Pattern Tiers</h4>
          <p>Patterns come in three complexity tiers:</p>
          <ul>
            <li><strong>Tier 1</strong>: Simple, sparse patterns â€“ great for intros</li>
            <li><strong>Tier 2</strong>: Medium complexity with embellishments</li>
            <li><strong>Tier 3</strong>: Complex, busy patterns â€“ perfect for climaxes</li>
          </ul>
        </div>
        <div class="help-section">
          <h4>ğŸ’¡ Tips</h4>
          <ul>
            <li>Use <strong>Randomize</strong> to quickly generate arrangements</li>
            <li><strong>Right-click</strong> a cell to quickly clear it</li>
            <li><strong>Double-click</strong> to cycle through patterns</li>
            <li>Hover over patterns in the selector to preview them</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- WAV Export Progress Modal -->
  <div class="modal" id="export-modal" role="dialog" aria-labelledby="export-title" aria-modal="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-sm">
      <div class="modal-header">
        <h3 id="export-title">ğŸ§ Exporting WAV</h3>
      </div>
      <div class="modal-body">
        <div class="export-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="export-progress"></div>
          </div>
          <p class="progress-text" id="export-status">Rendering audio...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="toast-container" id="toast-container" aria-live="polite"></div>

  <script src="app.js"></script>
</body>
</html>
