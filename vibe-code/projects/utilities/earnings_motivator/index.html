<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Falling Coins ‚Äî Earning Motivator</title>
  <style>
    :root{
      --sky-top:#88c9ff;
      --sky-mid:#bfe6ff;
      --sky-bottom:#f7fbff;
      --glass-bg: rgba(255,255,255,0.25);
      --glass-stroke: rgba(255,255,255,0.35);
      --text-dark:#0b2545;
      --muted:#456990;
      --counter-vw: 14vw;
      --counter-font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      --card-pad: 14px;
      --radius: 18px;
    }

    [data-theme="dark"] {
      --sky-top: #0b1026;
      --sky-mid: #1a2a4a;
      --sky-bottom: #2c3e50;
      --glass-bg: rgba(0, 0, 0, 0.3);
      --glass-stroke: rgba(255, 255, 255, 0.1);
      --text-dark: #e0e6ed;
      --muted: #a0aec0;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: var(--counter-font); color: var(--text-dark); }

    /* Sky */
    .sky { position: fixed; inset: 0; overflow: hidden;
      background: linear-gradient(180deg, var(--sky-top), var(--sky-mid) 55%, var(--sky-bottom));
      box-shadow: inset 0 0 200px rgba(0,0,0,0.08); z-index: 0; }
    .cloud { position:absolute; width: 500px; height: 180px; top:10%;
      background:
        radial-gradient(ellipse at 30% 40%, #fff 0%, #fff 45%, #ffffffcc 46%, #ffffff99 70%, transparent 72%),
        radial-gradient(ellipse at 55% 55%, #fff 0%, #fff 35%, #ffffffcc 36%, #ffffff99 60%, transparent 62%),
        radial-gradient(ellipse at 75% 45%, #fff 0%, #fff 40%, #ffffffcc 41%, #ffffff99 63%, transparent 65%);
      filter: blur(0.5px); opacity: .6; border-radius: 50% / 40%;
      animation: drift 120s linear infinite; will-change: transform; }
    @keyframes drift { to { transform: translateX(calc(100vw + 1400px)) scale(var(--scale, 1)); } }

    /* HUD / Controls */
    .hud { position: fixed; left: 50%; top: 30px; transform: translateX(-50%);
      display: grid; gap: 12px; grid-template-columns: 1fr; width: min(1100px, calc(100vw - 32px)); z-index: 5; }
    .card { background: var(--glass-bg); backdrop-filter: blur(8px) saturate(1.1);
      border: 1px solid var(--glass-stroke); box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border-radius: var(--radius); padding: var(--card-pad); }

    /* Massive center counter */
    .center { position: fixed; inset: 0; display: grid; place-items: center; z-index: 4; pointer-events: none; }
    #bigAmount { margin: 0; font-weight: 900; letter-spacing: .5px; text-align: center;
      font-variant-numeric: tabular-nums lining-nums; line-height: 1.02;
      font-size: clamp(56px, var(--counter-vw, 14vw), 220px);
      text-shadow: 0 2px 0 rgba(255,255,255,0.9), 0 20px 60px rgba(0,0,0,0.15); }

    /* Controls */
    .controls { display:flex; flex-direction: column; gap: 16px; }
    .controls-row { display: flex; align-items: flex-end; justify-content: space-between; gap: 20px; flex-wrap: wrap; width: 100%; }
    
    .inputs-group { display: flex; align-items: flex-end; gap: 12px; flex-wrap: wrap; }
    .actions-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .stack { display:flex; flex-direction: column; gap: 6px; }
    label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: .06em; opacity:.5; display:block; }
    .note { font-size: 11px; opacity: .5; margin-top: 2px; white-space: nowrap; }
    
    input[type="number"], select {
      height: 40px; border-radius: 10px; border:1px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.8);
      padding: 0 12px; font-size: 14px; font-weight: 600; color: var(--text-dark);
      outline: none; box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
      transition: all 0.2s ease; }
    input#salary { width: 140px; }
    select#mode, select#currency { width: 130px; }
    
    input[type="number"]:focus, select:focus { border-color: #ffcc33; background: #fff; box-shadow: 0 0 0 3px rgba(255,204,51,0.2); }
    input[type="range"]{ width: 100%; min-width: 100px; }

    .btn { height: 40px; border-radius: 10px; padding: 0 16px; font-weight: 800; font-size: 13px;
      border: 0; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: inline-flex; align-items: center; justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn:active { transform: translateY(0); }
    
    .btn.icon { width: 40px; padding: 0; font-size: 16px; }
    .primary { background: #ffcc33; color: #7a5a00; }
    .primary:hover { background: #ffd54b; }
    .neutral { background: rgba(255,255,255,0.9); color: var(--text-dark); border: 1px solid rgba(0,0,0,0.05); }
    .neutral:hover { background: #fff; }

    /* Panels (Visual & History side-by-side) */
    .panels { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
    details.panel { background: var(--glass-bg); border:1px solid var(--glass-stroke); border-radius: var(--radius); padding: 6px 10px; }
    details.panel[open] { padding-bottom: 10px; }
    details.panel summary { list-style: none; cursor: pointer; font-weight: 900; letter-spacing: .02em; padding: 8px 6px; }
    .panel-body { padding: 0 6px 8px; display: grid; gap: 10px; }
    .grid-2 { display: grid; gap: 10px 14px; grid-template-columns: 1fr 1fr; align-items: center; }
    .field { display: contents; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.55); border:1px solid rgba(0,0,0,0.06); font-weight: 700; font-size: 12px; }

    /* Coins */
    .coins-layer { position: fixed; inset: 0; overflow: hidden; z-index: 1; pointer-events: none; }
    #coinsCanvas { width: 100%; height: 100%; display: block; }

    /* Milestones */
    .milestone-toast {
      position: fixed; bottom: 30px; right: 30px;
      background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
      padding: 16px 24px; border-radius: 20px; border: 1px solid var(--glass-stroke);
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      display: flex; align-items: center; gap: 12px;
      transform: translateY(100px); opacity: 0;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 100;
    }
    .milestone-toast.show { transform: translateY(0); opacity: 1; }
    .milestone-icon { font-size: 24px; }
    .milestone-text { display: flex; flex-direction: column; }
    .milestone-title { font-weight: 800; font-size: 14px; color: var(--text-dark); }
    .milestone-desc { font-size: 12px; color: var(--muted); }

    /* History chart */
    .history .panel-body { gap: 12px; }
    .chart { width: 100%; height: 180px; }
    .chart text { font-size: 10px; fill: #234; opacity:.75; }

    @media (max-width: 900px){ .panels { grid-template-columns: 1fr; } }
    @media (max-width: 640px) { .right { width: 100%; justify-content: flex-start; } }
  </style>
</head>
<body>
  <div class="sky" id="sky" aria-hidden="true"></div>

  <button id="showHud" class="btn glass" style="position: fixed; top: 20px; left: 20px; z-index: 10; display: none; background: var(--glass-bg); backdrop-filter: blur(10px); border: 1px solid var(--glass-stroke);">‚öôÔ∏è Settings</button>

  <div class="hud" id="mainHud">
    <section class="card controls">
      <div class="controls-row">
        <div class="inputs-group">
          <div class="stack">
            <label id="salaryLabel" for="salary">Monthly salary</label>
            <input id="salary" type="number" min="0" step="100" placeholder="80000" inputmode="decimal"/>
            <div id="calcNote" class="note">Based on 157.5 hrs/month</div>
          </div>
          <div class="stack">
            <label for="mode">Mode</label>
            <select id="mode">
              <option value="monthly">Per month</option>
              <option value="hourly">Per hour</option>
            </select>
          </div>
          <div class="stack">
            <label for="currency">Currency</label>
            <select id="currency">
              <option value="DKK">DKK</option>
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <button class="btn primary" id="apply">Apply</button>
        </div>
        
        <div class="actions-group">
          <button class="btn neutral icon" id="muteToggle" title="Toggle Sound">üîä</button>
          <button class="btn neutral icon" id="themeToggle" title="Toggle Dark Mode">üåì</button>
          <div style="width: 1px; height: 24px; background: rgba(0,0,0,0.1); margin: 0 4px;"></div>
          <button class="btn primary" id="start">Start</button>
          <button class="btn neutral" id="pause">Pause</button>
          <button class="btn neutral" id="reset">Reset</button>
          <button class="btn neutral icon" id="fullscreen" title="Toggle fullscreen">‚õ∂</button>
          <button class="btn neutral icon" id="hideHud" title="Hide Controls">‚úï</button>
        </div>
      </div>

      <!-- Side-by-side panels -->
      <div id="hudPanels" class="panels">
        <details class="panel" id="visualPanel">
          <summary>Visual settings</summary>
          <div class="panel-body">
            <div class="grid-2">
              <div class="field"><label for="rate">Coins / minute</label><input id="rate" type="range" min="1" max="600" value="36"/><span id="rateVal" class="pill">36</span></div>
              <div class="field"><label for="fallMode">Fall pattern</label><select id="fallMode"><option value="constant">Constant</option><option value="natural">Natural</option></select></div>
              <div class="field"><label for="fallSpeed">Fall speed</label><input id="fallSpeed" type="range" min="3000" max="15000" step="250" value="7000" /><span id="fallSpeedVal" class="pill">7000ms</span></div>
              <div class="field"><label for="coinTheme">Coin style</label><select id="coinTheme"><option value="gold">Gold</option><option value="silver">Silver</option><option value="copper">Copper</option></select></div>
            </div>
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.06); margin: 2px 0;" />
            <div class="grid-2">
              <div class="field"><label for="cloudCount">Clouds</label><input id="cloudCount" type="range" min="0" max="10" value="3" /><span id="cloudCountVal" class="pill">3</span></div>
              <div class="field"><label for="cloudSpeed">Cloud speed</label><input id="cloudSpeed" type="range" min="50" max="200" value="100" /><span class="pill" id="cloudSpeedVal">100%</span></div>
              <div class="field"><label for="cloudOpacity">Cloud opacity</label><input id="cloudOpacity" type="range" min="20" max="100" value="60" /><span class="pill" id="cloudOpacityVal">0.60</span></div>
              <div class="field"><label for="coinThemeX">&nbsp;</label><span></span></div>
            </div>
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.06); margin: 2px 0;" />
            <div class="grid-2">
              <div class="field"><label for="fontFamily">Font</label><select id="fontFamily"><option value="sans">Sans (default)</option><option value="serif">Serif</option><option value="mono">Monospace</option></select></div>
              <div class="field"><label for="counterSize">Counter size</label><input id="counterSize" type="range" min="8" max="24" value="14" /><span id="counterSizeVal" class="pill">14vw</span></div>
            </div>
          </div>
        </details>

        <details class="panel history" id="historyPanel">
          <summary>Earnings history</summary>
          <div class="panel-body">
            <div id="historySummary" class="note"></div>
            <svg id="historyChart" class="chart" viewBox="0 0 600 180" preserveAspectRatio="none"></svg>
          </div>
        </details>
      </div>
    </section>
  </div>

  <div class="center">
    <div class="stack" style="align-items: center;">
      <h1 id="bigAmount">0,0</h1>
      <div id="sessionAmount" class="pill" style="font-size: 18px; padding: 8px 16px; background: rgba(255,255,255,0.4);">Session: 0,0</div>
    </div>
  </div>
  <div class="coins-layer" id="coinsLayer" aria-hidden="true">
    <canvas id="coinsCanvas"></canvas>
  </div>

  <div id="milestoneToast" class="milestone-toast">
    <div class="milestone-icon" id="milestoneIcon">‚òï</div>
    <div class="milestone-text">
      <div class="milestone-title" id="milestoneTitle">Coffee Earned!</div>
      <div class="milestone-desc" id="milestoneDesc">You just earned enough for a coffee.</div>
    </div>
  </div>

  <script>
    (function(){
      const HOURS_PER_MONTH = 157.5; // 37.5 hrs/week √ó 4.2 weeks/month
      const bigAmount = document.getElementById('bigAmount');
      const sessionAmount = document.getElementById('sessionAmount');
      const salaryLabel = document.getElementById('salaryLabel');
      const calcNote = document.getElementById('calcNote');
      const salaryInput = document.getElementById('salary');
      const modeSelect = document.getElementById('mode');
      const currencySelect = document.getElementById('currency');
      const applyBtn = document.getElementById('apply');
      const startBtn = document.getElementById('start');
      const pauseBtn = document.getElementById('pause');
      const resetBtn = document.getElementById('reset');
      const fullscreenBtn = document.getElementById('fullscreen');
      const themeToggle = document.getElementById('themeToggle');
      const muteToggle = document.getElementById('muteToggle');
      const hideHudBtn = document.getElementById('hideHud');
      const showHudBtn = document.getElementById('showHud');
      const mainHud = document.getElementById('mainHud');

      const rateRange = document.getElementById('rate');
      const rateVal = document.getElementById('rateVal');
      const fallModeSel = document.getElementById('fallMode');
      const fallSpeed = document.getElementById('fallSpeed');
      const fallSpeedVal = document.getElementById('fallSpeedVal');
      const coinThemeSel = document.getElementById('coinTheme');
      const cloudCount = document.getElementById('cloudCount');
      const cloudCountVal = document.getElementById('cloudCountVal');
      const cloudSpeed = document.getElementById('cloudSpeed');
      const cloudSpeedVal = document.getElementById('cloudSpeedVal');
      const cloudOpacity = document.getElementById('cloudOpacity');
      const cloudOpacityVal = document.getElementById('cloudOpacityVal');
      const fontFamilySel = document.getElementById('fontFamily');
      const counterSize = document.getElementById('counterSize');
      const counterSizeVal = document.getElementById('counterSizeVal');

      const historyChart = document.getElementById('historyChart');
      const historySummary = document.getElementById('historySummary');

      const coinsCanvas = document.getElementById('coinsCanvas');
      const ctx = coinsCanvas.getContext('2d');
      const sky = document.getElementById('sky');

      const milestoneToast = document.getElementById('milestoneToast');
      const milestoneIcon = document.getElementById('milestoneIcon');
      const milestoneTitle = document.getElementById('milestoneTitle');
      const milestoneDesc = document.getElementById('milestoneDesc');

      // LocalStorage keys
      const K = {
        monthly: 'fc_monthly',
        hourly: 'fc_hourly',
        mode: 'fc_mode',
        currency: 'fc_currency',
        cpm: 'fc_cpm',
        fallMode: 'fc_fall_mode',
        fallMs: 'fc_fall_ms',
        coinTheme: 'fc_coin_theme',
        clouds: 'fc_clouds',
        cloudSpeed: 'fc_cloud_speed',
        cloudOpacity: 'fc_cloud_opacity',
        font: 'fc_font',
        fontVw: 'fc_font_vw',
        startedAt: 'fc_started_at',
        running: 'fc_running',
        hiddenAt: 'fc_hidden_at',
        earnedTotal: 'fc_earned_total',
        daily: 'fc_daily',
        sessionStart: 'fc_session_start',
        theme: 'fc_theme',
        hudVisible: 'fc_hud_visible',
        muted: 'fc_muted'
      };

      // Milestones
      const MILESTONES = [
        { val: 5, title: "Coffee Time!", desc: "You've earned a coffee.", icon: "‚òï" },
        { val: 15, title: "Lunch is on you!", desc: "You've earned a nice lunch.", icon: "üç±" },
        { val: 50, title: "Video Game!", desc: "You've earned a new game.", icon: "üéÆ" },
        { val: 100, title: "Fancy Dinner!", desc: "Time for a celebration.", icon: "ü•Ç" },
        { val: 500, title: "Weekend Trip!", desc: "You're crushing it.", icon: "‚úàÔ∏è" },
        { val: 1000, title: "New Tech!", desc: "Treat yourself to something shiny.", icon: "üíª" }
      ];

      // Audio Context for "Clink"
      let audioCtx = null;
      function playClink() {
        try {
          if (muted) return;
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = 'sine';
          osc.frequency.setValueAtTime(800 + Math.random() * 400, audioCtx.currentTime);
          osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 0.05);
          gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.1);
        } catch(e) {}
      }

      // ------- State -------
      let mode = localStorage.getItem(K.mode) || 'monthly';
      let monthly = Number(localStorage.getItem(K.monthly)) || 80000;
      let hourly = Number(localStorage.getItem(K.hourly)) || Math.round((monthly / HOURS_PER_MONTH) * 10) / 10;
      let currency = localStorage.getItem(K.currency) || 'DKK';
      let coinsPerMin = Number(localStorage.getItem(K.cpm)) || 36;
      let fallMode = localStorage.getItem(K.fallMode) || 'constant';
      let fallMs = Number(localStorage.getItem(K.fallMs)) || 7000;
      let coinTheme = localStorage.getItem(K.coinTheme) || 'gold';
      let cloudsNum = Number(localStorage.getItem(K.clouds)) || 3;
      let cloudsSpeedPct = Number(localStorage.getItem(K.cloudSpeed)) || 100;
      let cloudsOpacityPct = Number(localStorage.getItem(K.cloudOpacity)) || 60;
      let fontKey = localStorage.getItem(K.font) || 'sans';
      let fontVw = Number(localStorage.getItem(K.fontVw)) || 14;
      let theme = localStorage.getItem(K.theme) || 'light';
      let hudVisible = localStorage.getItem(K.hudVisible) !== '0';
      let muted = localStorage.getItem(K.muted) === '1';

      let running = localStorage.getItem(K.running) === '1';
      let startTimeEpoch = parseInt(localStorage.getItem(K.startedAt)||'0') || 0;
      let sessionStartEpoch = parseInt(localStorage.getItem(K.sessionStart)||'0') || Date.now();
      let spawnerTimer = null;
      let earnedTotal = Number(localStorage.getItem(K.earnedTotal)) || 0;
      let sessionEarned = 0;
      let reachedMilestones = new Set();

      // Canvas State
      let coins = [];
      let lastFrameTime = performance.now();

      // History helpers
      function dateKeyLocal(ms){ const d=new Date(ms); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
      function getDaily(){ try{ return JSON.parse(localStorage.getItem(K.daily)||'{}'); }catch(e){ return {}; } }
      function setDaily(obj){ localStorage.setItem(K.daily, JSON.stringify(obj)); }

      // ------- UI Init -------
      function syncControls(){
        modeSelect.value = mode;
        currencySelect.value = currency;
        rateRange.value = coinsPerMin; rateVal.textContent = coinsPerMin;
        fallModeSel.value = fallMode;
        fallSpeed.value = fallMs; fallSpeedVal.textContent = fallMs+"ms";
        coinThemeSel.value = coinTheme;
        cloudCount.value = cloudsNum; cloudCountVal.textContent = String(cloudsNum);
        cloudSpeed.value = cloudsSpeedPct; cloudSpeedVal.textContent = cloudsSpeedPct+"%";
        cloudOpacity.value = cloudsOpacityPct; cloudOpacityVal.textContent = (cloudsOpacityPct/100).toFixed(2);
        fontFamilySel.value = fontKey;
        counterSize.value = fontVw; counterSizeVal.textContent = fontVw+"vw";
        if(mode === 'monthly'){
          salaryLabel.textContent = 'Monthly salary'; salaryInput.placeholder = '80000'; salaryInput.value = monthly; calcNote.style.display = 'block';
        } else {
          salaryLabel.textContent = 'Hourly rate'; salaryInput.placeholder = '500'; salaryInput.value = hourly; calcNote.style.display = 'none';
        }
      }

      function applyVisuals(){
        const root = document.documentElement.style;
        let ff = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans"';
        if(fontKey === 'serif') ff = 'ui-serif, Georgia, Cambria, "Times New Roman", Times, serif';
        if(fontKey === 'mono') ff = 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        root.setProperty('--counter-font', ff);
        root.setProperty('--counter-vw', fontVw + 'vw');
        
        document.documentElement.setAttribute('data-theme', theme);
        mainHud.style.display = hudVisible ? 'grid' : 'none';
        showHudBtn.style.display = hudVisible ? 'none' : 'block';
        muteToggle.textContent = muted ? 'üîá' : 'üîä';

        rebuildClouds();
        resizeCanvas();
      }

      function resizeCanvas(){
        coinsCanvas.width = window.innerWidth * window.devicePixelRatio;
        coinsCanvas.height = window.innerHeight * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      }

      function rebuildClouds(){
        sky.innerHTML = '';
        for(let i=0;i<cloudsNum;i++){
          const c = document.createElement('div');
          c.className = 'cloud';
          const scale = 0.6 + Math.random()*0.9;
          const top = Math.round(Math.random()*60 + 5);
          const startX = - (200 + Math.random()*1200);
          const dur = ( (90 + Math.random()*120) * (100/Math.max(10,cloudsSpeedPct)) );
          c.style.setProperty('--scale', scale); c.style.top = top + '%'; c.style.left = startX + 'px';
          c.style.opacity = (cloudsOpacityPct/100).toString(); c.style.animationDuration = dur + 's';
          sky.appendChild(c);
        }
      }

      // Formatting
      function fmt1(n){ try{ const loc = currency === 'DKK' ? 'da-DK' : (currency === 'EUR' ? 'en-GB' : 'en-US'); return new Intl.NumberFormat(loc, { style:'currency', currency, minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(n); }catch(e){ return `${currency} ${Number(n).toFixed(1)}`; } }
      function currencySymbol(){ return currency === 'DKK' ? 'kr' : (currency === 'EUR' ? '‚Ç¨' : '$'); }

      function computeHourly(){ return mode === 'monthly' ? (monthly / 157.5) : hourly; }
      function perSecond(){ return computeHourly() / 3600; }

      function renderTotal(v, s){
        bigAmount.textContent = fmt1(v != null ? v : earnedTotal);
        sessionAmount.textContent = `Session: ${fmt1(s != null ? s : sessionEarned)}`;
        checkMilestones(s != null ? s : sessionEarned);
      }

      function checkMilestones(val){
        for(const m of MILESTONES){
          if(val >= m.val && !reachedMilestones.has(m.val)){
            reachedMilestones.add(m.val);
            showMilestone(m);
          }
        }
      }

      function showMilestone(m){
        milestoneIcon.textContent = m.icon;
        milestoneTitle.textContent = m.title;
        milestoneDesc.textContent = m.desc;
        milestoneToast.classList.add('show');
        setTimeout(() => milestoneToast.classList.remove('show'), 5000);
      }

      function persistTotals(){
        localStorage.setItem(K.earnedTotal, String(earnedTotal));
        localStorage.setItem(K.sessionStart, String(sessionStartEpoch));
      }

      function addEarningsOverInterval(startMs, endMs, ratePerSec){
        if(!(endMs>startMs)) return;
        const daily = getDaily(); let cur = startMs;
        while(cur < endMs){
          const d = new Date(cur);
          const nextMidnight = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 0,0,0,0).getTime();
          const segEnd = Math.min(endMs, nextMidnight);
          const amt = ((segEnd - cur)/1000) * ratePerSec; const key = dateKeyLocal(cur);
          daily[key] = (daily[key] || 0) + amt; cur = segEnd;
        }
        setDaily(daily); renderHistory();
      }

      // ------- Ticker -------
      let rafId = null;
      let tickStartPerf = 0;
      let tickStartEpoch = 0;

      function accruedSinceStart(){
        if(!running || !tickStartPerf) return 0;
        return ((performance.now() - tickStartPerf)/1000) * perSecond();
      }

      function tick(now){
        const dt = now - lastFrameTime;
        lastFrameTime = now;

        const currentAccrued = accruedSinceStart();
        renderTotal(earnedTotal + currentAccrued, sessionEarned + currentAccrued);

        updateCoins(dt);
        drawCoins();

        rafId = requestAnimationFrame(tick);
      }

      function startTicker(){
        if(!rafId){
          tickStartPerf = performance.now();
          tickStartEpoch = Date.now();
          lastFrameTime = performance.now();
          rafId = requestAnimationFrame(tick);
        }
      }

      function stopTicker(){
        if(rafId){
          cancelAnimationFrame(rafId);
          rafId = null;
        }
      }

      function settleAccrual(){
        if(running && tickStartPerf){
          const nowEpoch = Date.now();
          const delta = accruedSinceStart();
          if(delta>0){
            earnedTotal += delta;
            sessionEarned += delta;
            addEarningsOverInterval(tickStartEpoch, nowEpoch, perSecond());
            persistTotals();
          }
          tickStartPerf = performance.now();
          tickStartEpoch = nowEpoch;
          renderTotal();
        }
      }

      // ------- Canvas Coin Engine -------
      function createCoin(natural){
        const size = 28 + Math.random()*32;
        const dur = (natural ? (4000 + Math.random()*9000) : fallMs);
        const x = Math.random() * (window.innerWidth - size);
        const ry = (natural ? (Math.random() * 720) : 0);

        if (coinsPerMin < 100) playClink(); // Only play sound if rate is reasonable

        coins.push({
          x, y: -size - 50,
          size,
          dur,
          elapsed: 0,
          ry,
          rySpeed: 0.1 + Math.random() * 0.2,
          theme: coinTheme,
          symbol: currencySymbol()
        });
      }

      function updateCoins(dt){
        for(let i = coins.length - 1; i >= 0; i--){
          const c = coins[i];
          c.elapsed += dt;
          const progress = c.elapsed / c.dur;
          
          // Use a simple quadratic ease-in for natural acceleration without reversal
          // This ensures coins always move downwards.
          const ease = progress * progress; 
          c.y = -100 + (window.innerHeight + 200) * ease;
          c.ry += c.rySpeed * dt;

          if(c.y > window.innerHeight + 100 || progress > 1.5){
            coins.splice(i, 1);
          }
        }
      }

      function drawCoins(){
        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        coins.forEach(c => {
          ctx.save();
          ctx.translate(c.x + c.size/2, c.y + c.size/2);
          ctx.rotate(c.ry * Math.PI / 180);
          const scaleX = Math.cos(c.ry * 0.05);
          ctx.scale(scaleX, 1);

          // Draw Coin Face
          let color1, color2, color3, border;
          if(c.theme === 'silver'){
            color1 = '#ffffff'; color2 = '#d5deea'; color3 = '#9aa6b8'; border = '#cbd5df';
          } else if(c.theme === 'copper'){
            color1 = '#ffe1c6'; color2 = '#f08f3a'; color3 = '#a4550f'; border = '#e38a3f';
          } else {
            color1 = '#fff8c6'; color2 = '#ffc72b'; color3 = '#c98d0a'; border = '#f3c12b';
          }

          const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, c.size/2);
          grad.addColorStop(0, color2);
          grad.addColorStop(0.7, color2);
          grad.addColorStop(1, color3);

          ctx.beginPath();
          ctx.arc(0, 0, c.size/2, 0, Math.PI * 2);
          ctx.fillStyle = grad;
          ctx.fill();
          ctx.strokeStyle = border;
          ctx.lineWidth = 2;
          ctx.stroke();

          // Shine
          ctx.beginPath();
          ctx.arc(-c.size/6, -c.size/6, c.size/10, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(255,255,255,0.5)';
          ctx.fill();

          // Symbol
          ctx.fillStyle = c.theme === 'silver' ? '#5b6777' : (c.theme === 'copper' ? '#6a3a00' : '#7a5a00');
          ctx.font = `bold ${c.size * 0.4}px sans-serif`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(c.symbol, 0, 0);

          ctx.restore();
        });
      }

      function startSpawner(){
        stopSpawner();
        (fallMode === 'natural') ? startSpawnerNatural() : startSpawnerConstant();
      }
      function startSpawnerConstant(){
        const interval = Math.max(120, Math.floor(60000 / Math.max(1, coinsPerMin)));
        spawnerTimer = setInterval(() => { createCoin(false); }, interval);
        createCoin(false);
      }
      function startSpawnerNatural(){
        const lambda = coinsPerMin/60000;
        const spawn = () => {
          const u = Math.random();
          const wait = Math.max(120, Math.floor(-Math.log(1-u)/lambda));
          spawnerTimer = setTimeout(() => { createCoin(true); spawn(); }, wait);
        };
        spawn();
      }
      function stopSpawner(){
        if(spawnerTimer){
          (fallMode==='natural'?clearTimeout:clearInterval)(spawnerTimer);
          spawnerTimer = null;
        }
      }

      // Visibility / gap handling
      function handleHidden(){
        if(!running) return;
        if(!localStorage.getItem(K.hiddenAt)){
          localStorage.setItem(K.hiddenAt, String(Date.now()));
        }
        stopSpawner();
        settleAccrual();
        stopTicker();
      }
      function handleVisible(){
        if(!running) return;
        const hiddenAt = parseInt(localStorage.getItem(K.hiddenAt)||'0');
        if(hiddenAt > 0){
          const nowEpoch = Date.now();
          const deltaEarned = ((nowEpoch - hiddenAt)/1000) * perSecond();
          if(deltaEarned>0){
            earnedTotal += deltaEarned;
            sessionEarned += deltaEarned;
            addEarningsOverInterval(hiddenAt, nowEpoch, perSecond());
            persistTotals();
          }
          localStorage.removeItem(K.hiddenAt);
        }
        renderTotal();
        tickStartPerf = performance.now();
        tickStartEpoch = Date.now();
        startTicker();
        startSpawner();
      }

      document.addEventListener('visibilitychange', () => {
        if(document.visibilityState === 'hidden') handleHidden();
        else if(document.visibilityState === 'visible') handleVisible();
      });
      window.addEventListener('blur', handleHidden);
      window.addEventListener('focus', handleVisible);
      window.addEventListener('beforeunload', () => {
        if(running){
          localStorage.setItem(K.hiddenAt, String(Date.now()));
          const nowEpoch = Date.now();
          addEarningsOverInterval(tickStartEpoch||nowEpoch, nowEpoch, perSecond());
          persistTotals();
        }
      });
      setInterval(() => { if(running) settleAccrual(); }, 60000);

      // Controls behavior
      function applySettings(){
        const val = Number(salaryInput.value);
        if(!Number.isFinite(val) || val < 0){ alert('Please enter a valid number.'); return; }
        settleAccrual();
        currency = currencySelect.value;
        localStorage.setItem(K.currency, currency);
        if(mode === 'monthly'){
          monthly = val;
          localStorage.setItem(K.monthly, String(monthly));
        } else {
          hourly = val;
          localStorage.setItem(K.hourly, String(hourly));
        }
        syncControls();
        renderTotal(earnedTotal, sessionEarned);
      }

      function setMode(newMode){
        if(newMode !== 'monthly' && newMode !== 'hourly') return;
        if(newMode === mode) return;
        settleAccrual();
        mode = newMode;
        localStorage.setItem(K.mode, mode);
        if(mode === 'monthly'){
          salaryLabel.textContent = 'Monthly salary'; salaryInput.placeholder = '80000'; salaryInput.value = monthly; calcNote.style.display = 'block';
        } else {
          salaryLabel.textContent = 'Hourly rate'; salaryInput.placeholder = '500'; salaryInput.value = hourly; calcNote.style.display = 'none';
        }
      }

      function start(){
        if(running) return;
        running = true;
        localStorage.setItem(K.running, '1');
        if(!startTimeEpoch){
          startTimeEpoch = Date.now();
          localStorage.setItem(K.startedAt, String(startTimeEpoch));
        }
        sessionStartEpoch = Date.now();
        localStorage.setItem(K.sessionStart, String(sessionStartEpoch));
        sessionEarned = 0;
        reachedMilestones.clear();

        const hiddenAt = parseInt(localStorage.getItem(K.hiddenAt)||'0');
        if(hiddenAt>0){
          const nowEpoch = Date.now();
          const deltaEarned = ((nowEpoch-hiddenAt)/1000) * perSecond();
          if(deltaEarned>0){
            earnedTotal += deltaEarned;
            sessionEarned += deltaEarned;
            addEarningsOverInterval(hiddenAt, nowEpoch, perSecond());
            persistTotals();
          }
          localStorage.removeItem(K.hiddenAt);
        }
        startTicker();
        startSpawner();
      }

      function pause(){
        if(!running) return;
        settleAccrual();
        running = false;
        localStorage.setItem(K.running, '0');
        stopTicker();
        stopSpawner();
        localStorage.removeItem(K.hiddenAt);
      }

      function reset(){
        running = false;
        stopTicker();
        stopSpawner();
        tickStartPerf = 0;
        tickStartEpoch = 0;
        startTimeEpoch = 0;
        sessionStartEpoch = 0;
        earnedTotal = 0;
        sessionEarned = 0;
        reachedMilestones.clear();
        coins = [];
        renderTotal();
        persistTotals();
        localStorage.removeItem(K.startedAt);
        localStorage.removeItem(K.sessionStart);
        localStorage.removeItem(K.hiddenAt);
        localStorage.setItem(K.running, '0');
      }

      // Fullscreen
      async function toggleFullscreen(){
        try{
          if(!document.fullscreenElement){
            if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
          } else {
            if(document.exitFullscreen) await document.exitFullscreen();
          }
        }catch(e){}
      }

      // History chart render
      function renderHistory(){
        const daily = getDaily();
        const keys = Object.keys(daily).sort();
        const last = keys.slice(-14);
        const values = last.map(k => daily[k]);
        const max = Math.max(1, ...values);
        const W = 600, H = 180, pad = 24;
        const bw = (W - pad*2) / Math.max(1,last.length);
        let svg = `<rect x="0" y="0" width="${W}" height="${H}" fill="transparent"/>`;
        last.forEach((k, i) => {
          const v = values[i];
          const h = Math.round((v/max) * (H - pad*2));
          const x = Math.round(pad + i*bw + bw*0.1);
          const y = Math.round(H - pad - h);
          const barw = Math.round(bw*0.8);
          svg += `<rect x="${x}" y="${y}" width="${barw}" height="${h}" rx="6" ry="6" fill="#ffcc33" opacity="0.85"/>`;
          svg += `<text x="${x + barw/2}" y="${H - 8}" text-anchor="middle">${k.slice(5)}</text>`;
        });
        historyChart.innerHTML = svg;
        const total = values.reduce((a,b)=>a+b,0);
        historySummary.textContent = last.length ? `Last ${last.length} days total: ${fmt1(total)}` : 'No history yet.';
      }

      // Wire up
      applyBtn.addEventListener('click', applySettings);
      startBtn.addEventListener('click', start);
      pauseBtn.addEventListener('click', pause);
      resetBtn.addEventListener('click', reset);
      fullscreenBtn.addEventListener('click', toggleFullscreen);

      themeToggle.addEventListener('click', () => {
        theme = theme === 'light' ? 'dark' : 'light';
        localStorage.setItem(K.theme, theme);
        applyVisuals();
      });

      muteToggle.addEventListener('click', () => {
        muted = !muted;
        localStorage.setItem(K.muted, muted ? '1' : '0');
        applyVisuals();
      });

      hideHudBtn.addEventListener('click', () => {
        hudVisible = false;
        localStorage.setItem(K.hudVisible, '0');
        applyVisuals();
      });

      showHudBtn.addEventListener('click', () => {
        hudVisible = true;
        localStorage.setItem(K.hudVisible, '1');
        applyVisuals();
      });

      rateRange.addEventListener('input', e => {
        coinsPerMin = Number(e.target.value);
        rateVal.textContent = coinsPerMin;
        localStorage.setItem(K.cpm, String(coinsPerMin));
        if(running) startSpawner();
      });
      fallModeSel.addEventListener('change', e => {
        fallMode = e.target.value;
        localStorage.setItem(K.fallMode, fallMode);
        if(running) startSpawner();
      });
      fallSpeed.addEventListener('input', e => {
        fallMs = Number(e.target.value);
        fallSpeedVal.textContent = fallMs+"ms";
        localStorage.setItem(K.fallMs, String(fallMs));
      });
      coinThemeSel.addEventListener('change', e => {
        coinTheme = e.target.value;
        localStorage.setItem(K.coinTheme, coinTheme);
      });

      cloudCount.addEventListener('input', e => {
        cloudsNum = Number(e.target.value);
        cloudCountVal.textContent = String(cloudsNum);
        localStorage.setItem(K.clouds, String(cloudsNum));
        rebuildClouds();
      });
      cloudSpeed.addEventListener('input', e => {
        cloudsSpeedPct = Number(e.target.value);
        cloudSpeedVal.textContent = cloudsSpeedPct+"%";
        localStorage.setItem(K.cloudSpeed, String(cloudsSpeedPct));
        rebuildClouds();
      });
      cloudOpacity.addEventListener('input', e => {
        cloudsOpacityPct = Number(e.target.value);
        cloudOpacityVal.textContent = (cloudsOpacityPct/100).toFixed(2);
        localStorage.setItem(K.cloudOpacity, String(cloudsOpacityPct));
        rebuildClouds();
      });

      fontFamilySel.addEventListener('change', e => {
        fontKey = e.target.value;
        localStorage.setItem(K.font, fontKey);
        applyVisuals();
      });
      counterSize.addEventListener('input', e => {
        fontVw = Number(e.target.value);
        counterSizeVal.textContent = fontVw+"vw";
        localStorage.setItem(K.fontVw, String(fontVw));
        applyVisuals();
      });

      modeSelect.addEventListener('change', e => { setMode(e.target.value); });

      document.addEventListener('keydown', (e) => {
        if(e.code === 'Space'){ e.preventDefault(); running ? pause() : start(); }
        if(e.key.toLowerCase() === 'f'){ toggleFullscreen(); }
      });

      window.addEventListener('resize', () => {
        resizeCanvas();
      });

      // Initial render
      syncControls();
      applyVisuals();
      renderTotal();
      renderHistory();

      if(running){
        const hiddenAt = parseInt(localStorage.getItem(K.hiddenAt)||'0');
        if(hiddenAt>0){
          const nowEpoch = Date.now();
          const deltaEarned = ((nowEpoch-hiddenAt)/1000) * perSecond();
          if(deltaEarned>0){
            earnedTotal += deltaEarned;
            sessionEarned += deltaEarned;
            addEarningsOverInterval(hiddenAt, nowEpoch, perSecond());
            persistTotals();
          }
          localStorage.removeItem(K.hiddenAt);
        }
        startTicker();
        startSpawner();
      }
    })();
  </script>
</body>
</html>
